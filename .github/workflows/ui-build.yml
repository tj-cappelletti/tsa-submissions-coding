name: UI Build

on:
  push:
    paths:
      - 'ui/**'
      - '.github/workflows/ui-build.yml'

  workflow_dispatch:

env:
  NODE_VERSION: '22.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ui

jobs:
  gitVersionJob:
    name: CI - GitVersion Workflow
    uses: webstorm-tech/workflows/.github/workflows/gitversion-workflow.yml@v5

  buildApplicationJob:
    runs-on: ubuntu-latest
    needs: gitVersionJob
    permissions:
      contents: read
      packages: write

    defaults:
      run:
        working-directory: ./ui

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './ui/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || echo "No lint script found"

      - name: Test
        run: npm run test -- --run || echo "No tests configured"

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-artifacts
          path: ./ui/dist/tsa-submissions-coding-ui/browser
          retention-days: 30

  buildDockerContainerJob:
    name: CI - Build Docker Container
    needs: [gitVersionJob, buildApplicationJob]
    permissions:
      packages: write
    uses: webstorm-tech/workflows/.github/workflows/docker-build-container-workflow.yml@v5
    with:
      dockerfile: ui/Dockerfile
      dockerNamespace: ui
      dockerRegistry: ghcr.io
      dockerRepository: ${{ github.repository }}
      dockerWorkingDirectory: ui/
      majorVersion: ${{ needs.gitVersionJob.outputs.majorReleaseLabel }}
      majorMinorVersion: ${{ needs.gitVersionJob.outputs.majorMinorReleaseLabel }}
      pushContainerImage: ${{ github.event_name != 'pull_request' }}
      semVer: ${{ needs.gitVersionJob.outputs.semVer }}
    secrets:
      REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tagRepositoryJob:
    name: CI - Tag Repository
    if: github.ref == 'refs/heads/main'
    needs: [gitVersionJob]
    uses: webstorm-tech/workflows/.github/workflows/github-tag-repo-workflow.yml@v5
    with:
      semVer: ${{ needs.gitVersionJob.outputs.semVer }}
